{% extends "base.html" %}

{% block title %}Scoreboard - David wird 30{% endblock %}

{% block content %}
<script>
    const MODERATOR_PASSWORD = '123';

    // Funktionen fÃ¼r Moderator Lock/Unlock auf Scoreboard
    function unlockModeratorScoreboard() {
        const password = document.getElementById('moderator-password-scoreboard').value;
        if (password === MODERATOR_PASSWORD) {
            document.getElementById('moderator-locked-scoreboard').style.display = 'none';
            document.getElementById('moderator-unlocked-scoreboard').style.display = 'grid';
        } else {
            alert('âŒ Falsches Passwort!');
            document.getElementById('moderator-password-scoreboard').value = '';
        }
    }

    function lockModeratorScoreboard() {
        document.getElementById('moderator-locked-scoreboard').style.display = 'flex';
        document.getElementById('moderator-unlocked-scoreboard').style.display = 'none';
        document.getElementById('moderator-password-scoreboard').value = '';
    }

    // Enter-Taste fÃ¼r Passwort-Input aktivieren
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('moderator-password-scoreboard');
        if (passwordInput) {
            passwordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    unlockModeratorScoreboard();
                }
            });
        }

        // Auto-Update des Scoreboards
        updateScoreboard();
        setInterval(updateScoreboard, 2000);
    });

    async function updateScoreboard() {
        try {
            const response = await fetch('/get_scores');
            const scores = await response.json();
            document.getElementById('david-score').textContent = scores.david;
            document.getElementById('gaeste-score').textContent = scores.gaeste;
        } catch (error) {
            console.error('Fehler beim Aktualisieren der Punkte:', error);
        }
    }

    async function addPoints(team, points) {
        try {
            const response = await fetch(`/add_points/${team}/${points}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.success) {
                updateScoreboard();
            }
        } catch (error) {
            console.error('Fehler beim HinzufÃ¼gen von Punkten:', error);
        }
    }

    async function resetAllScores() {
        if (confirm('Wirklich alle Punkte zurÃ¼cksetzen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden!')) {
            try {
                const response = await fetch('/reset_scores', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success) {
                    updateScoreboard();
                    alert('Alle Punkte wurden zurÃ¼ckgesetzt!');
                }
            } catch (error) {
                console.error('Fehler beim ZurÃ¼cksetzen der Punkte:', error);
            }
        }
    }
</script>

<div class="scoreboard-header">
    <h1>ğŸ† SCOREBOARD ğŸ†</h1>
    <p class="scoreboard-subtitle">Gesamtpunkte</p>
</div>

<!-- HAUPTANZEIGE DER PUNKTE - BEAMER-FREUNDLICH -->
<section class="scoreboard-display">
    <div class="score-container">
        <div class="score-team david-team">
            <h2>David</h2>
            <div class="score-value" id="david-score">{{ scores.david }}</div>
            <div class="score-label">Punkte</div>
        </div>

        <div class="score-vs">VS</div>

        <div class="score-team gaeste-team">
            <h2>GÃ¤ste</h2>
            <div class="score-value" id="gaeste-score">{{ scores.gaeste }}</div>
            <div class="score-label">Punkte</div>
        </div>
    </div>
</section>

<!-- DAVID'S REWARD TIER -->
<section class="david-reward-section">
    <h2>ğŸ† David's Feg-Utensil</h2>
    <div id="reward-tier-display" class="reward-tier-display">
        <div class="current-reward">
            <div class="reward-icon-large" id="reward-icon">ğŸª¥</div>
            <div class="reward-description">
                <h3 id="reward-title">0â€“19 Punkte</h3>
                <p id="reward-text">Die traurigste Version â€“ eine ZahnbÃ¼rste</p>
            </div>
        </div>
        <div class="reward-progress-bar">
            <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>
</section>

<script>
    // Update reward tier based on David's points
    function updateRewardTier() {
        const davidScore = parseInt(document.getElementById('david-score').textContent);
        const icon = document.getElementById('reward-icon');
        const title = document.getElementById('reward-title');
        const text = document.getElementById('reward-text');
        const progressBar = document.getElementById('progress-bar');
        
        let tierPercentage = Math.min((davidScore / 41) * 100, 100);
        progressBar.style.width = tierPercentage + '%';
        
        if (davidScore >= 41) {
            icon.textContent = 'ğŸŒŸ';
            title.textContent = '41+ Punkte';
            text.textContent = 'Endboss-Modus â€“ der groÃŸe Feger!';
        } else if (davidScore >= 31) {
            icon.textContent = 'ğŸ§¹';
            title.textContent = '31â€“40 Punkte';
            text.textContent = 'Semi-Profi â€“ ein kleiner Handfeger';
        } else if (davidScore >= 20) {
            icon.textContent = 'ğŸ¥•';
            title.textContent = '20â€“30 Punkte';
            text.textContent = 'Fortgeschrittenes Fegen â€“ ein Kehrblech';
        } else {
            icon.textContent = 'ğŸª¥';
            title.textContent = '0â€“19 Punkte';
            text.textContent = 'Die traurigste Version â€“ eine ZahnbÃ¼rste';
        }
    }

    // Update reward tier whenever scores change
    const originalUpdateScoreboard = updateScoreboard;
    updateScoreboard = function() {
        originalUpdateScoreboard();
        updateRewardTier();
    };
</script>

<!-- MODERATOR-KONTROLLEN -->
<section class="moderator-controls-section">
    <h2>ğŸ›ï¸ Moderator-Bereich: Punkte verwalten</h2>
    
    <div id="moderator-locked-scoreboard" class="moderator-locked">
        <p>ğŸ”’ Moderator-Bereich ist gesperrt</p>
        <input type="password" id="moderator-password-scoreboard" placeholder="Passwort eingeben..." class="moderator-password-input">
        <button class="btn btn-secondary" onclick="unlockModeratorScoreboard()">
            ğŸ”“ Entsperren
        </button>
    </div>

    <div id="moderator-unlocked-scoreboard" class="points-manager" style="display: none;">
        <!-- David's Punkte -->
        <div class="team-controls">
            <h3>David's Punkte</h3>
            <div class="button-group">
                <button class="btn btn-lg btn-success" onclick="addPoints('david', 1)">
                    â• +1
                </button>
                <button class="btn btn-lg btn-success" onclick="addPoints('david', 2)">
                    â• +2
                </button>
                <button class="btn btn-lg btn-success" onclick="addPoints('david', 3)">
                    â• +3
                </button>
                <button class="btn btn-lg btn-success" onclick="addPoints('david', 6)">
                    â• +6
                </button>
            </div>
            <div class="button-group">
                <button class="btn btn-lg btn-warning" onclick="addPoints('david', -1)">
                    â– -1
                </button>
                <button class="btn btn-lg btn-warning" onclick="addPoints('david', -2)">
                    â– -2
                </button>
            </div>
        </div>

        <!-- GÃ¤ste's Punkte -->
        <div class="team-controls">
            <h3>GÃ¤ste's Punkte</h3>
            <div class="button-group">
                <button class="btn btn-lg btn-success" onclick="addPoints('gaeste', 1)">
                    â• +1
                </button>
                <button class="btn btn-lg btn-success" onclick="addPoints('gaeste', 2)">
                    â• +2
                </button>
                <button class="btn btn-lg btn-success" onclick="addPoints('gaeste', 3)">
                    â• +3
                </button>
                <button class="btn btn-lg btn-success" onclick="addPoints('gaeste', 6)">
                    â• +6
                </button>
            </div>
            <div class="button-group">
                <button class="btn btn-lg btn-warning" onclick="addPoints('gaeste', -1)">
                    â– -1
                </button>
                <button class="btn btn-lg btn-warning" onclick="addPoints('gaeste', -2)">
                    â– -2
                </button>
            </div>
        </div>

        <!-- RESET BUTTON - NUR FÃœR MODERATOREN -->
        <div class="moderator-actions">
            <button class="btn btn-danger btn-lg" onclick="resetAllScores()">
                ğŸ”„ Alle Punkte zurÃ¼cksetzen
            </button>
        </div>

        <!-- LOCK BUTTON -->
        <div class="action-buttons">
            <button class="btn btn-secondary btn-lg" onclick="lockModeratorScoreboard()">
                ğŸ”’ Sperren
            </button>
        </div>
    </div>
    </div>
</section>

<!-- SPIELÃœBERSICHT MIT PUNKTE -->
<section class="games-summary">
    <h2>ğŸ® SpielÃ¼bersicht & Punkteverteilung</h2>
    <table class="games-table">
        <thead>
            <tr>
                <th>Spiel</th>
                <th>Name</th>
                <th>Punkte</th>
            </tr>
        </thead>
        <tbody>
            {% for game in games %}
            <tr>
                <td class="game-num">{{ game.number }}</td>
                <td class="game-name">{{ game.name }}</td>
                <td class="game-points">{{ game.punkte }} Punkte</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- NAVIGATION -->
<section class="navigation-section">
    <div class="nav-buttons">
        <a href="/spieluebersicht" class="btn btn-secondary btn-lg">
            ğŸ® ZurÃ¼ck zu den Spielen
        </a>
        <a href="/" class="btn btn-primary btn-lg">
            ğŸ  Zur Startseite
        </a>
    </div>
</section>

{% endblock %}
