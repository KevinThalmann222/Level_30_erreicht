{% extends "base.html" %}

{% block title %}{{ game.name }} - David wird 30{% endblock %}

{% block content %}
<script>
    // Starte Auto-Update der Abstimmungen wenn die Seite geladen ist
    document.addEventListener('DOMContentLoaded', function() {
        startAutoUpdate('{{ game.id }}', 1000);
    });
</script>

<div class="game-header-section">
    <div class="game-badge">Spiel {{ game.number }} / 6</div>
    <h1>{{ game.name }}</h1>
    <p class="points-badge">ğŸ’° {{ game.punkte }} Punkte</p>
</div>

<!-- SPIELBESCHREIBUNG UND REGELN -->
<section class="game-content">
    <div class="game-info">
        <h2>ğŸ“ Spielbeschreibung</h2>
        <p class="description-text">{{ game.beschreibung }}</p>

        <h3>ğŸ“‹ Spielregeln:</h3>
        <ul class="rules-list">
            {% for regel in game.regeln %}
            <li>{{ regel }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- BILD-PLATZHALTER -->
    <div class="game-image-container">
        <img src="{{ url_for('static', filename='spiel' ~ game.number ~ '.png') }}" alt="{{ game.name }}" class="game-image-large">
    </div>
</section>

<!-- ABSTIMMUNGSBEREICH FÃœR GÃ„STE -->
<section class="voting-section">
    <h2>ğŸ—³ï¸ Jetzt abstimmen!</h2>
    <p class="voting-intro">Wer gewinnt dieses Spiel?</p>
    
    <div class="vote-buttons">
        {% for option_id, option_name in game.voting_options %}
        <button class="btn btn-vote" onclick="submitVote('{{ game.id }}', '{{ option_id }}')">
            {{ option_name }}
        </button>
        {% endfor %}
    </div>
</section>

<!-- LIVE-ABSTIMMUNGSERGEBNISSE -->
<section class="results-section">
    <h2>ğŸ“Š Live-Ergebnisse</h2>
    <p class="results-info">Die Abstimmungen aktualisieren sich automatisch.</p>
    <div id="votes-{{ game.id }}">
        <div class="vote-results">
            {% for option_id, option_name in game.voting_options %}
            <div class="vote-item">
                <span>{{ option_name }}: 0 (0%)</span>
                <div class="vote-bar">
                    <div class="vote-fill" style="width: 0%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- MODERATOR-BEREICH (RESET ABSTIMMUNGEN) -->
<section class="moderator-section">
    <h2>ğŸ›ï¸ Moderator-Bereich</h2>
    <div id="moderator-locked" class="moderator-locked">
        <p>ğŸ”’ Moderator-Bereich ist gesperrt</p>
        <input type="password" id="moderator-password" placeholder="Passwort eingeben..." class="moderator-password-input">
        <button class="btn btn-secondary" onclick="unlockModerator()">
            ğŸ”“ Entsperren
        </button>
    </div>
    <div id="moderator-unlocked" class="moderator-controls" style="display: none;">
        <div class="moderator-control-group">
            <h3>ğŸ—³ï¸ Gewinner festlegen:</h3>
            <button class="btn btn-success" onclick="setGameWinner('{{ game.id }}', 'david')">
                âœ… David gewinnt ({{ game.punkte }} Punkte)
            </button>
            <button class="btn btn-primary" onclick="setGameWinner('{{ game.id }}', 'gaeste')">
                âœ… GÃ¤ste gewinnen ({{ game.punkte }} Punkte)
            </button>
        </div>
        <div class="moderator-control-group">
            <button class="btn btn-warning" onclick="if(confirm('Abstimmungen wirklich zurÃ¼cksetzen?')) { resetVotes('{{ game.id }}'); }">
                ğŸ”„ Abstimmungen zurÃ¼cksetzen
            </button>
        </div>
        <div class="moderator-control-group">
            <button class="btn btn-secondary" onclick="lockModerator()">
                ğŸ”’ Sperren
            </button>
        </div>
    </div>
</section>

<!-- NAVIGATION ZUM NÃ„CHSTEN SPIEL -->
<section class="navigation-section">
    <div class="nav-buttons">
        <a href="/spieluebersicht" class="btn btn-secondary">
            â—€ ZurÃ¼ck zur Ãœbersicht
        </a>
        {% if next_game %}
        <a href="/spiel/{{ next_game.id }}" class="btn btn-primary">
            NÃ¤chstes Spiel: {{ next_game.name }} â–¶
        </a>
        {% else %}
        <a href="/scoreboard" class="btn btn-success">
            ğŸ† Zum Abschluss-Scoreboard â–¶
        </a>
        {% endif %}
    </div>
</section>

<script>
    const MODERATOR_PASSWORD = '123';

    // Funktion zum Entsperren des Moderator-Bereichs
    function unlockModerator() {
        const password = document.getElementById('moderator-password').value;
        if (password === MODERATOR_PASSWORD) {
            document.getElementById('moderator-locked').style.display = 'none';
            document.getElementById('moderator-unlocked').style.display = 'flex';
        } else {
            alert('âŒ Falsches Passwort!');
            document.getElementById('moderator-password').value = '';
        }
    }

    // Funktion zum Sperren des Moderator-Bereichs
    function lockModerator() {
        document.getElementById('moderator-locked').style.display = 'flex';
        document.getElementById('moderator-unlocked').style.display = 'none';
        document.getElementById('moderator-password').value = '';
    }

    // Enter-Taste fÃ¼r Passwort-Input aktivieren
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('moderator-password');
        if (passwordInput) {
            passwordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    unlockModerator();
                }
            });
        }
    });

    // Funktion zum ZurÃ¼cksetzen der Abstimmungen
    async function resetVotes(gameId) {
        try {
            const response = await fetch(`/reset_votes/${gameId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.success) {
                console.log('Votes reset:', data.message);
                updateVoteDisplay(gameId);
            }
        } catch (error) {
            console.error('Fehler beim ZurÃ¼cksetzen der Abstimmungen:', error);
        }
    }

    // Funktion zum Festlegen des Spielgewinners und automatisches HinzufÃ¼gen der Punkte
    async function setGameWinner(gameId, winner) {
        try {
            const response = await fetch(`/set_game_winner/${gameId}/${winner}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.success) {
                alert(`âœ… ${data.message}`);
                console.log('Scores:', data.scores);
                // Optional: Seite aktualisieren oder zum nÃ¤chsten Spiel gehen
            } else {
                alert('âŒ Fehler: ' + data.message);
            }
        } catch (error) {
            console.error('Fehler beim Festlegen des Gewinners:', error);
        }
    }
</script>

{% endblock %}
