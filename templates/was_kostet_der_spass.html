{% extends "spiel.html" %}

{% block content %}
<script>
    // Starte Auto-Update der Abstimmungen wenn die Seite geladen ist
    document.addEventListener('DOMContentLoaded', function() {
        startAutoUpdate('{{ game.id }}', 1000);
    });
</script>

<div class="game-header-section">
    <div class="game-badge">Spiel {{ game.number }} / 6</div>
    <h1>{{ game.name }}</h1>
    <p class="points-badge">ğŸ’° {{ game.punkte }} Punkte</p>
</div>

<!-- SPIELBESCHREIBUNG UND REGELN -->
<section class="game-content">
    <div class="game-info">
        <h2>ğŸ“ Spielbeschreibung</h2>
        <p class="description-text">{{ game.beschreibung }}</p>

        <h3>ğŸ“‹ Spielregeln:</h3>
        <ul class="rules-list">
            {% for regel in game.regeln %}
            <li>{{ regel }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- eBay IMAGE DISPLAY (controlled by moderator) -->
    <div class="game-image-container">
        {% if show_image and current_image %}
            <img src="{{ url_for('static', filename='ebay/' + current_image.filename) }}" alt="eBay Inserat" class="game-image-large">
        {% else %}
            <img src="{{ url_for('static', filename='spiel' ~ game.number ~ '.png') }}" alt="{{ game.name }}" class="game-image-large">
        {% endif %}
    </div>
</section>

<!-- ABSTIMMUNGSBEREICH FÃœR GÃ„STE -->
<section class="voting-section">
    <h2>ğŸ—³ï¸ Jetzt abstimmen!</h2>
    <p class="voting-intro">Wer gewinnt dieses Spiel?</p>
    
    <div class="vote-buttons">
        {% for option_id, option_name in game.voting_options %}
        <button class="btn btn-vote" onclick="submitVote('{{ game.id }}', '{{ option_id }}')">
            {{ option_name }}
        </button>
        {% endfor %}
    </div>
</section>

<!-- LIVE-ABSTIMMUNGSERGEBNISSE -->
<section class="results-section">
    <h2>ğŸ“Š Live-Ergebnisse</h2>
    <p class="results-info">Die Abstimmungen aktualisieren sich automatisch.</p>
    <div id="votes-{{ game.id }}">
        <div class="vote-results">
            {% for option_id, option_name in game.voting_options %}
            <div class="vote-item">
                <span>{{ option_name }}: 0 (0%)</span>
                <div class="vote-bar">
                    <div class="vote-fill" style="width: 0%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- MODERATOR-BEREICH (RESET ABSTIMMUNGEN + eBay IMAGE CONTROLS) -->
<section class="moderator-section">
    <h2>ğŸ›ï¸ Moderator-Bereich</h2>
    {% if is_moderator %}
    <div id="moderator-unlocked" class="moderator-controls">
        <!-- DEBUG: Show ebay_images count -->
        {% if config.DEBUG %}
        <p style="background: yellow; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; font-size: 0.9rem;">
            DEBUG: ebay_images count = {{ ebay_images|length }}, ebay_images = {{ ebay_images }}
        </p>
        {% endif %}
        
        <!-- eBay IMAGE CONTROLS - HORIZONTAL SCROLLABLE GALLERY -->
        <div class="moderator-control-group">
            <h3>ğŸ–¼ï¸ eBay Bild-Kontrolle:</h3>
            
            <!-- Image Gallery Container -->
            <div class="ebay-gallery-container">
                <button class="ebay-scroll-btn ebay-scroll-left" onclick="scrollEbayGallery('left')">â—„</button>
                
                <div class="ebay-gallery-wrapper">
                    <div class="ebay-gallery">
                        {% if ebay_images %}
                            {% for img in ebay_images %}
                            <div class="ebay-gallery-item" onclick="selectAndShowEbayImage({{ img.id }}, '{{ img.filename }}')">
                                <img src="{{ url_for('static', filename='ebay/' + img.filename) }}" alt="{{ img.filename }}" class="ebay-thumbnail">
                                <div class="ebay-item-info">
                                    <p class="ebay-price">ğŸ’° {{ "%.2f"|format(img.price) }} â‚¬</p>
                                    <p class="ebay-filename">{{ img.filename }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p style="color: #888; padding: 2rem; text-align: center; grid-column: 1/-1;">Keine eBay-Bilder gefunden</p>
                        {% endif %}
                    </div>
                </div>
                
                <button class="ebay-scroll-btn ebay-scroll-right" onclick="scrollEbayGallery('right')">â–º</button>
            </div>
            
            <!-- Control Buttons -->
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showSelectedEbayImage()">
                    ğŸ‘ï¸ AusgewÃ¤hltes Bild anzeigen
                </button>
                <button class="btn btn-warning" onclick="hideEbayImage()">
                    ğŸ™ˆ Bild verbergen
                </button>
            </div>
            
            <!-- Current Image Status -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0, 212, 255, 0.1); border: 2px solid rgba(0, 212, 255, 0.3); border-radius: 12px;">
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem;">
                    <strong>Aktuell ausgewÃ¤hltes Bild:</strong>
                </p>
                <p id="current-image-name" style="margin: 0.5rem 0 0 0; color: var(--primary); font-weight: 600; font-size: 1.1rem;">
                    {% if current_image %}
                        {{ current_image.filename }}
                    {% else %}
                        Klicke auf ein Bild zum AuswÃ¤hlen
                    {% endif %}
                </p>
                {% if current_image and is_moderator %}
                <p style="margin: 1rem 0 0 0; padding-top: 1rem; border-top: 1px solid rgba(0, 212, 255, 0.2); color: var(--accent-green); font-weight: 600;">
                    ğŸ’° Preis: {{ "%.2f"|format(current_image.price) }} â‚¬
                </p>
                {% endif %}
            </div>
        </div>

        <!-- GAME CONTROLS -->
        <div class="moderator-control-group">
            <h3>ğŸ—³ï¸ Gewinner festlegen:</h3>
            <button class="btn btn-success" onclick="setGameWinner('{{ game.id }}', 'david')">
                âœ… David gewinnt ({{ game.punkte }} Punkte)
            </button>
            <button class="btn btn-primary" onclick="setGameWinner('{{ game.id }}', 'gaeste')">
                âœ… GÃ¤ste gewinnen ({{ game.punkte }} Punkte)
            </button>
        </div>
        <div class="moderator-control-group">
            <button class="btn btn-warning" onclick="if(confirm('Abstimmungen wirklich zurÃ¼cksetzen?')) { resetVotes('{{ game.id }}'); }">
                ğŸ”„ Abstimmungen zurÃ¼cksetzen
            </button>
        </div>
        <div class="moderator-control-group">
            <button class="btn btn-secondary" onclick="logoutModerator()">
                ğŸšª Abmelden
            </button>
        </div>
    </div>
    {% else %}
    <div class="moderator-locked">
        <p>ğŸ”’ Moderator-Bereich ist gesperrt</p>
        <p style="font-size: 0.9em; color: #666;">Verwende den Moderator-Button in der Navigation zum Anmelden.</p>
    </div>
    {% endif %}
</section>

<!-- NÃ„CHSTES SPIEL -->
{% if next_game %}
<section class="next-game-section">
    <h2>â¡ï¸ NÃ¤chstes Spiel</h2>
    <div class="next-game-card">
        <h3>{{ next_game.name }}</h3>
        <p>{{ next_game.beschreibung }}</p>
        <a href="{{ url_for('spiel', game_id=next_game.id) }}" class="btn btn-primary">
            Zum nÃ¤chsten Spiel â†’
        </a>
    </div>
</section>
{% endif %}

<!-- JAVASCRIPT FOR EBAY IMAGE CONTROLS -->
<script>
    const MODERATOR_PASSWORD = '123';
    
    // Track selected image ID
    let selectedImageId = null;

    function unlockModerator() {
        const password = document.getElementById('moderator-password').value;
        
        // Send to server for authentication
        fetch('/moderator_login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password: password })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                document.getElementById('moderator-locked').style.display = 'none';
                document.getElementById('moderator-unlocked').style.display = 'flex';
            } else {
                alert('âŒ Falsches Passwort!');
                document.getElementById('moderator-password').value = '';
            }
        })
        .catch(e => {
            alert('Fehler: ' + e);
            document.getElementById('moderator-password').value = '';
        });
    }

    function logoutModerator() {
        fetch('/moderator_logout', { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            document.getElementById('moderator-locked').style.display = 'flex';
            document.getElementById('moderator-unlocked').style.display = 'none';
            document.getElementById('moderator-password').value = '';
        });
    }

    // Scroll gallery left/right
    function scrollEbayGallery(direction) {
        const gallery = document.querySelector('.ebay-gallery');
        const scrollAmount = 300;
        
        if (direction === 'left') {
            gallery.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else {
            gallery.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

    // Select an image from gallery
    function selectAndShowEbayImage(imageId, filename) {
        selectedImageId = imageId;
        
        // Update UI - highlight selected item
        document.querySelectorAll('.ebay-gallery-item').forEach(item => {
            item.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // Update current image display
        document.getElementById('current-image-name').textContent = filename;
    }

    // Show the selected image
    function showSelectedEbayImage() {
        if (selectedImageId === null) {
            alert('Bitte wÃ¤hle ein Bild aus der Galerie!');
            return;
        }
        
        fetch(`/ebay_show_image/${selectedImageId}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    location.reload();
                } else {
                    alert('Fehler: ' + d.error);
                }
            });
    }

    function showEbayImage() {
        // Legacy function for backward compatibility
        showSelectedEbayImage();
    }

    function hideEbayImage() {
        fetch('/ebay_hide_image', { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    document.getElementById('current-image-name').textContent = 'Kein Bild aktiv';
                    location.reload();
                } else {
                    alert('Fehler: ' + d.error);
                }
            });
    }

    // Funktion zum Festlegen des Spielgewinners und automatisches HinzufÃ¼gen der Punkte
    async function setGameWinner(gameId, winner) {
        try {
            const response = await fetch(`/set_game_winner/${gameId}/${winner}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.success) {
                alert(`âœ… ${data.message}`);
                console.log('Scores:', data.scores);
            } else {
                alert('âŒ Fehler: ' + data.message);
            }
        } catch (error) {
            console.error('Fehler beim Festlegen des Gewinners:', error);
        }
    }

    // Funktion zum ZurÃ¼cksetzen der Abstimmungen
    async function resetVotes(gameId) {
        try {
            const response = await fetch(`/reset_votes/${gameId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            if (data.success) {
                console.log('Votes reset:', data.message);
                location.reload();
            } else {
                alert('âŒ Fehler: ' + data.message);
            }
        } catch (error) {
            console.error('Fehler beim ZurÃ¼cksetzen der Abstimmungen:', error);
        }
    }

    // Enter-Taste fÃ¼r Passwort-Input aktivieren
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('moderator-password');
        if (passwordInput) {
            passwordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    unlockModerator();
                }
            });
        }
    });
</script>

{% endblock %}
